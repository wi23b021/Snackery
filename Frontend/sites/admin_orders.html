<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Admin – Bestellungen verwalten</title>
    <link rel="stylesheet" href="../res/css/style.css">

    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            // === ADMINPRÜFUNG ===
            fetch("/Snackery/Backend/logic/requestHandler.php?action=getProfile", {
                    credentials: "include"
                })
                .then(res => res.json())
                .then(user => {
                    if (!user || user.role !== "admin") {
                        window.location.href = "login.html";
                    }
                })
                .catch(() => {
                    window.location.href = "login.html";
                });

            // === BESTELLUNGEN LADEN ===
            fetch("/Snackery/Backend/logic/requestHandler.php?action=getOrders", {
                    credentials: "include"
                })
                .then(res => res.json())
                .then(orders => {
                    const container = document.getElementById("orderTableContainer");

                    if (!Array.isArray(orders) || orders.length === 0) {
                        container.innerHTML = "<p>❌ Es wurden noch keine Bestellungen aufgegeben.</p>";
                        return;
                    }

                    const rows = orders.map(order => `
                        <tr>
                            <td>${order.id}</td>
                            <td>${order.user_id}</td>
                            <td>${order.order_date}</td>
                            <td>
                                <select class="statusSelect" data-id="${order.id}">
                                    <option value="offen" ${order.status === "offen" ? "selected" : ""}>offen</option>
                                    <option value="in Bearbeitung" ${order.status === "in Bearbeitung" ? "selected" : ""}>in Bearbeitung</option>
                                    <option value="auf dem Weg" ${order.status === "auf dem Weg" ? "selected" : ""}>auf dem Weg</option>
                                    <option value="geliefert" ${order.status === "geliefert" ? "selected" : ""}>geliefert</option>
                                </select>
                            </td>
                            <td>
                                <button class="btn deleteOrderBtn" data-id="${order.id}">🗑️ Löschen</button>
                            </td>
                        </tr>
                    `).join("");

                    container.innerHTML = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Bestell-ID</th>
                                    <th>Benutzer-ID</th>
                                    <th>Datum</th>
                                    <th>Status</th>
                                    <th>Aktion</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;

                    // === STATUS ÄNDERN ===
                    document.querySelectorAll(".statusSelect").forEach(select => {
                        select.addEventListener("change", function() {
                            const orderId = this.dataset.id;
                            const newStatus = this.value;

                            fetch("/Snackery/Backend/logic/requestHandler.php?action=editOrder", {
                                    method: "POST",
                                    credentials: "include",
                                    headers: {
                                        "Content-Type": "application/x-www-form-urlencoded"
                                    },
                                    body: `order_id=${orderId}&status=${encodeURIComponent(newStatus)}`
                                })
                                .then(res => res.json())
                                .then(data => {
                                    alert(data.success ? "✅ Status aktualisiert." : "❌ Fehler beim Aktualisieren.");
                                })
                                .catch(() => alert("❌ Fehler beim Senden der Statusänderung."));
                        });
                    });

                    // === BESTELLUNG LÖSCHEN ===
                    document.querySelectorAll(".deleteOrderBtn").forEach(btn => {
                        btn.addEventListener("click", function() {
                            const orderId = this.dataset.id;
                            if (confirm("❗ Bestellung wirklich löschen?")) {
                                fetch(`/Snackery/Backend/logic/requestHandler.php?action=deleteOrder&id=${orderId}`, {
                                        method: "DELETE",
                                        credentials: "include"
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        alert(data.success ? "✅ Bestellung gelöscht." : "❌ Fehler beim Löschen.");
                                        if (data.success) location.reload();
                                    })
                                    .catch(() => alert("❌ Fehler beim Löschen der Bestellung."));
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error("❌ Fehler beim Laden der Bestellungen:", error);
                    document.getElementById("orderTableContainer").innerHTML =
                        "<p>❌ Fehler beim Laden der Daten.</p>";
                });
        });
    </script>
</head>

<body>

    <!-- === HEADER === -->
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="../res/img/snackery-logo.jpg" alt="Snackery Logo">
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Startseite</a></li>
                <li><a href="admin_products.html">Produkte</a></li>
                <li><a href="admin_orders.html">Bestellungen</a></li>
                <li><a href="admin_users.html">Benutzer</a></li>
                <li><a href="../../Backend/logout.php">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- === INHALT === -->
    <main style="padding: 40px;">
        <h2>Bestellungen verwalten</h2>
        <div id="orderTableContainer">
            <p>🔄 Bestellungen werden geladen...</p>
        </div>
    </main>

    <!-- === FUSSZEILE === -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Snackery</p>
            <div class="footer-links">
                <a href="impressum.html">Impressum</a>
                <a href="hilfe.html">Hilfe</a>
            </div>
        </div>
    </footer>

</body>

</html>