<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Produkte verwalten ‚Äì Snackery</title>
    <link rel="stylesheet" href="../res/css/style.css">

    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            // === ADMINPR√úFUNG ===
            fetch("/Snackery/Backend/logic/requestHandler.php?action=getProfile", {
                    credentials: "include"
                })
                .then(res => res.json())
                .then(user => {
                    if (!user || user.role !== "admin") {
                        window.location.href = "login.html";
                    }
                })
                .catch(() => window.location.href = "login.html");

            // === PRODUKTE LADEN ===
            fetch("/Snackery/Backend/logic/requestHandler.php?action=getProducts", {
                    credentials: "include"
                })
                .then(res => res.json())
                .then(products => {
                    const container = document.getElementById("productTableContainer");

                    if (!Array.isArray(products) || products.length === 0) {
                        container.innerHTML = "<p>‚ùå Keine Produkte gefunden.</p>";
                        return;
                    }

                    const rows = products.map(product => `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>${parseFloat(product.price).toFixed(2).replace(".", ",")} ‚Ç¨</td>
                            <td>${product.category}</td>
                            <td>
                                <a class="btn" href="edit_product.html?id=${product.id}">Bearbeiten</a>
                                <button class="btn deleteBtn" data-id="${product.id}">üóëÔ∏è L√∂schen</button>
                            </td>
                        </tr>
                    `).join("");

                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead style="background-color: #f5f5f5;">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Preis</th>
                                    <th>Kategorie</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    `;

                    // === PRODUKT L√ñSCHEN ===
                    document.querySelectorAll(".deleteBtn").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const productId = btn.dataset.id;

                            if (confirm("‚ùó Willst du dieses Produkt wirklich l√∂schen?")) {
                                fetch(`/Snackery/Backend/logic/requestHandler.php?action=deleteProduct&id=${productId}`, {
                                        method: "DELETE",
                                        credentials: "include"
                                    })
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success) {
                                            alert("‚úÖ Produkt gel√∂scht.");
                                            window.location.reload();
                                        } else {
                                            alert("‚ùå Fehler beim L√∂schen: " + (result.message || "Unbekannter Fehler."));
                                        }
                                    })
                                    .catch(err => {
                                        console.error("‚ùå Serverfehler:", err);
                                        alert("‚ùå Serverfehler beim L√∂schen.");
                                    });
                            }
                        });
                    });
                })
                .catch(err => {
                    console.error("‚ùå Fehler beim Laden der Produkte:", err);
                    document.getElementById("productTableContainer").innerHTML =
                        "<p>‚ùå Fehler beim Laden der Produkte.</p>";
                });
        });
    </script>
</head>

<body>

    <!-- === HEADER === -->
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="../res/img/snackery-logo.jpg" alt="Snackery Logo">
            </a>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Startseite</a></li>
                <li><a href="admin.html">Adminbereich</a></li>
                <li><a href="../../Backend/logout.php">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- === INHALT === -->
    <main class="profile-container">
        <h2>Produkte verwalten</h2>
        <a href="add_product.html" class="btn">+ Neues Produkt hinzuf√ºgen</a>
        <div id="productTableContainer" style="margin-top: 30px;">
            <p>üîÑ Produkte werden geladen...</p>
        </div>
    </main>

    <!-- === FUSSZEILE === -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Snackery</p>
            <div class="footer-links">
                <a href="impressum.html">Impressum</a>
                <a href="hilfe.html">Hilfe</a>
            </div>
        </div>
    </footer>

</body>

</html>