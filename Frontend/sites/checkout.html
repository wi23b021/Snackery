<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Checkout ‚Äì Snackery</title>

    <!-- Binde das zentrale Stylesheet ein (damit Seite sch√∂n aussieht) -->
    <link rel="stylesheet" href="../res/css/style.css">
</head>

<body>

    <!-- ========== HEADER ========== -->
    <header>
        <div class="logo">
            <!-- Logo ist klickbar und f√ºhrt zur Startseite -->
            <a href="/Snackery/index.html">
                <img src="../res/img/snackery-logo.jpg" alt="Snackery Logo">
            </a>
        </div>

        <!-- Navigation zwischen den Seiten -->
        <nav>
            <ul>
                <li><a href="/Snackery/index.html">Startseite</a></li>
                <li><a href="products.html">Produkte</a></li>
                <li><a href="cart.html">Warenkorb</a></li>
                <li><a href="profil.html">Profil</a></li>
                <li><a href="../../Backend/logout.php">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- ========== HAUPTBEREICH ========== -->
    <main style="padding: 40px;">
        <h1>üõí Checkout</h1>

        <!-- üìù Formular zum Eingeben der Adresse und Auswahl der Zahlungsmethode -->
        <form id="checkoutForm" class="register-container">

            <!-- Lieferadresse -->
            <h2>Lieferadresse</h2>
            <input type="text" name="street" placeholder="Stra√üe" required>
            <input type="text" name="housenumber" placeholder="Hausnummer" required>
            <input type="text" name="postalcode" placeholder="PLZ" required>
            <input type="text" name="city" placeholder="Ort" required>

            <!-- Zahlungsmethode -->
            <h2>Zahlungsmethode</h2>
            <select name="payment_method" id="paymentMethod" required>
                <option value="">Bitte ausw√§hlen</option>
                <option value="erlagschein">Erlagschein</option>
                <option value="bankomat">Bankomat</option>
            </select>

            <!-- Erlagschein-Vorschau, wird nur sichtbar, wenn 'Erlagschein' gew√§hlt ist -->
            <div id="erlagscheinPreview" style="display:none; margin-top:20px;">
                <h3>üßæ Erlagschein-Vorschau:</h3>
                <p>Empf√§nger: Snackery e.U.</p>
                <p>IBAN: AT12 3456 7890 1234 5678</p>
                <p>Betrag: Wird automatisch nach Warenkorb berechnet</p>
            </div>

            <!-- √úbersicht der bestellten Produkte -->
            <h2>Bestell√ºbersicht</h2>
            <div id="orderSummary"></div>

            <!-- Anzeige des Gesamtpreises -->
            <h3 id="totalPrice">Gesamt: ‚Ç¨ 0.00</h3>

            <!-- Button zum Abschicken der Bestellung -->
            <button type="submit">Bestellung abschicken</button>
        </form>

        <!-- Feld f√ºr Fehlermeldungen oder Erfolgsmeldung -->
        <p id="feedbackMessage" style="margin-top:20px; font-weight: bold;"></p>
    </main>

    <!-- ========== FU√üBEREICH ========== -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Snackery</p>
            <div class="footer-links">
                <a href="impressum.html">Impressum</a>
                <a href="hilfe.html">Hilfe</a>
            </div>
        </div>
    </footer>

    <!-- ========== JAVASCRIPT ========== -->
    <script>
        let cart = []; // Lokale Variable f√ºr den Warenkorb

        // üõí Funktion zum Laden des Warenkorbs aus LocalStorage
        function loadCart() {
            cart = JSON.parse(localStorage.getItem("cart")) || []; // Falls leer, [] nehmen
            const summary = document.getElementById("orderSummary");
            const totalPriceElement = document.getElementById("totalPrice");

            summary.innerHTML = ""; // Altes HTML l√∂schen

            if (cart.length === 0) {
                summary.innerHTML = "<p>Dein Warenkorb ist leer.</p>";
                totalPriceElement.textContent = "Gesamt: ‚Ç¨ 0.00";
                return;
            }

            let total = 0; // Gesamtsumme

            // Alle Produkte durchgehen und HTML bauen
            cart.forEach(item => {
                const div = document.createElement("div");
                div.innerHTML = `<p><strong>${item.name}</strong> ‚Äì ‚Ç¨ ${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>`;
                summary.appendChild(div);

                total += item.price * item.quantity; // Preis addieren
            });

            // Gesamtsumme anzeigen
            totalPriceElement.textContent = `Gesamt: ‚Ç¨ ${total.toFixed(2)}`;
        }

        // üßæ Vorschau f√ºr Erlagschein ein- oder ausblenden
        document.getElementById("paymentMethod").addEventListener("change", (e) => {
            const preview = document.getElementById("erlagscheinPreview");
            if (e.target.value === "erlagschein") {
                preview.style.display = "block"; // Anzeigen
            } else {
                preview.style.display = "none"; // Verstecken
            }
        });

        // üì® Bestellung abschicken
        document.getElementById("checkoutForm").addEventListener("submit", function(e) {
            e.preventDefault(); // Neuladen verhindern

            if (cart.length === 0) {
                alert("‚ùå Dein Warenkorb ist leer!");
                return;
            }

            // Formulardaten sammeln
            const formData = new FormData(this);
            formData.append("cart", JSON.stringify(cart)); // Warenkorb anh√§ngen

            // AJAX-Request an Backend senden
            fetch("../../Backend/logic/requestHandler.php?action=placeOrder", {
                    method: "POST",
                    body: formData,
                    credentials: "include"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem("cart"); // Warenkorb lokal l√∂schen
                        window.location.href = "checkout_success.html"; // Weiterleitung
                    } else {
                        document.getElementById("feedbackMessage").textContent = "‚ùå Fehler: " + (data.message || "Unbekannter Fehler");
                    }
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById("feedbackMessage").textContent = "‚ùå Serverfehler.";
                });
        });

        // Beim Laden der Seite sofort Warenkorb anzeigen
        window.addEventListener("DOMContentLoaded", loadCart);
    </script>

</body>

</html>