<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Checkout ‚Äì Snackery</title>

    <link rel="stylesheet" href="../res/css/style.css">
    <script src="../res/js/session-check.js" defer></script>
</head>

<body>

    <!-- ========== HEADER ========== -->
    <header>
        <div class="logo">
            <a href="/Snackery/index.html">
                <img src="../res/img/snackery-logo.jpg" alt="Snackery Logo">
            </a>
        </div>

        <nav>
            <ul>
                <li><a href="/Snackery/index.html">Startseite</a></li>
                <li><a href="products.html">Produkte</a></li>
                <li><a href="cart.html">Warenkorb</a></li>
                <li><a href="profil.html">Mein Profil</a></li>
                <li><a href="../../Backend/logout.php">Logout</a></li>
            </ul>
        </nav>
    </header>

    <!-- ========== HAUPTBEREICH ========== -->
    <main style="padding: 40px;">
        <h1 style="text-align: center;">üõí Checkout</h1>

        <form id="checkoutForm" class="register-container">
            <h2>Lieferadresse</h2>
            <input type="text" name="street" placeholder="Stra√üe" required>
            <input type="text" name="housenumber" placeholder="Hausnummer" required>
            <input type="text" name="postalcode" placeholder="PLZ" required>
            <input type="text" name="city" placeholder="Ort" required>

            <h2>Zahlungsmethode</h2>
            <select name="payment_method" id="paymentMethod" required>
                <option value="">Bitte ausw√§hlen</option>
                <option value="erlagschein">Erlagschein</option>
            </select>

            <div id="erlagscheinPreview" style="display: none; margin-top: 20px;">
                <h3>üßæ Erlagschein-Vorschau:</h3>
                <p>Empf√§nger: Snackery e.U.</p>
                <p>IBAN: AT12 3456 7890 1234 5678</p>
                <p>Betrag: kann man im kommenden Abschnitt "Bestell√ºbersicht" sehen</p>
                <p>Nach Zahlungserhalt, bekommen Sie die Bestellung innerhalb von 7 Tagen !</p>
            </div>

            <h2>Bestell√ºbersicht</h2>
            <div id="orderSummary"></div>
            <h3 id="totalPrice">Gesamt: ‚Ç¨ 0.00</h3>

            <button type="submit">Bestellung abschicken</button>
        </form>

        <p id="feedbackMessage" style="margin-top:20px; font-weight: bold;"></p>
    </main>

    <!-- ========== FOOTER ========== -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Snackery</p>
            <div class="footer-links">
                <a href="impressum.html">Impressum</a> |
                <a href="hilfe.html">Hilfe</a>
            </div>
        </div>
    </footer>

    <script>
        let cart = [];

        function loadCart() {
            cart = JSON.parse(localStorage.getItem("cart")) || [];
            const summary = document.getElementById("orderSummary");
            const totalPriceElement = document.getElementById("totalPrice");

            summary.innerHTML = "";

            if (cart.length === 0) {
                summary.innerHTML = "<p>üß∫ Dein Warenkorb ist leer.</p>";
                totalPriceElement.textContent = "Gesamt: ‚Ç¨ 0.00";
                return;
            }

            let total = 0;

            cart.forEach(item => {
                const div = document.createElement("div");
                div.innerHTML = `<p><strong>${item.name}</strong> ‚Äì ‚Ç¨ ${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>`;
                summary.appendChild(div);

                total += item.price * item.quantity;
            });

            totalPriceElement.textContent = `Gesamt: ‚Ç¨ ${total.toFixed(2)}`;
        }

        document.getElementById("paymentMethod").addEventListener("change", (e) => {
            const preview = document.getElementById("erlagscheinPreview");
            preview.style.display = e.target.value === "erlagschein" ? "block" : "none";
        });

        document.getElementById("checkoutForm").addEventListener("submit", function(e) {
            e.preventDefault();

            if (cart.length === 0) {
                alert("‚ùå Dein Warenkorb ist leer!");
                return;
            }

            const formData = new FormData(this);
            formData.append("cart", JSON.stringify(cart));

            fetch("../../Backend/logic/requestHandler.php?action=placeOrder", {
                    method: "POST",
                    body: formData,
                    credentials: "include"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem("cart");
                        window.location.href = "checkout_success.html";
                    } else {
                        document.getElementById("feedbackMessage").textContent = "‚ùå Fehler: " + (data.message || "Unbekannter Fehler");
                    }
                })
                .catch(error => {
                    console.error("Fehler:", error);
                    document.getElementById("feedbackMessage").textContent = "‚ùå Serverfehler beim Abschicken.";
                });
        });

        window.addEventListener("DOMContentLoaded", loadCart);
    </script>

</body>

</html>